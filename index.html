<!DOCTYPE HTML>
<html>
    <head>
    <link rel="stylesheet" href="https://cdn.webix.com/edge/webix.css" type="text/css">
    <script src="https://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
    <script src="ruleset.js"></script>
    <script src="common.js"></script>
    </head>
    <body>
        <script type="text/javascript" charset="utf-8">

		
        var attacker={
			name: '',
			class: '',
			attack: {},
			terrain: {}};
        var attackerId=null;
        var defender=attacker;
		var defenderId=null;
		var attackerTerrain='';
		var defenderTerrain='';
		var damage_dataset = [
			{ att: 20.5, def: 8.7, dmg: 0 },
			{ att: 10.3, def: 99.9, dmg: 1 }
		];			
       
        var unitData= [{ id: "1", open:true, value:"Sapiens", data: []},
                { id:"2", open:true, value: "Khraleans", data:[]},
                { id:"3", open:true, value:"Titans", data:[]}];
        unitData.sapiens = unitData[0];
        unitData.khraleans = unitData[1];
        unitData.titans = unitData[2];
        for (var unit in RuleSet.Unit) {
            var rules=RuleSet.Unit[unit];
            unitData[rules.race].data.push({id: unit, value: rules.name, open: true});
        }
        
        
		function updateTable() {
			$$("attHealth").define("max", 10+parseInt($$("attVeteran").getValue()));
			$$("attHealth").refresh();
			$$("defHealth").define("max", 10+parseInt($$("defVeteran").getValue()));
			$$("defHealth").refresh();
		
			var table = $$('datatable');
			
			

			
			/*var attAtt = attacker.attack[defender.class];
			var defAtt = defender.attack[attacker.class];
			var attDef = attacker.defense;
			var defDef = defender.defense;
			
			
			var attTerrainValues = attacker.terrain[attackerTerrain];
			var Aa = parseInt(attAtt);
			var Ad = parseInt(attDef);
			var Da = parseInt(defAtt);
			var Dd = parseInt(defDef);
			var attackerBonus = 0;
			if (attTerrainValues) {
				var attAttBonus = attTerrainValues[1];
				var attDefBonus = attTerrainValues[2];
				if (attAtt) {
					Aa += attAttBonus;
					if (attAttBonus > 0) attAtt = attAtt + "+" + attAttBonus;
					else if (attAttBonus < 0) attAtt = attAtt + "" + attAttBonus;
					var x = parseInt($$("attVeteran").getValue());
					if (x) attAtt = attAtt + "+" + x;
					Aa += x;
					attackerBonus += x;
					var x = parseInt($$("attGangup").getValue());
					if (x) attAtt = attAtt + "+" + x;
					Aa += x;
					attackerBonus += x;
					var x = parseInt($$("attPopup").getValue())*4;
					if (x) attAtt = attAtt + "+" + x;
					Aa += x;
					attackerBonus += x;
				}
				if (attDef) {
					Ad += attDefBonus;
					if (attDefBonus > 0) attDef = attDef + "+" + attDefBonus;
					else if (attDefBonus < 0) attDef = attDef + "" + attDefBonus;
					var pierce = defender.armorPiercing ? defender.armorPiercing[attacker.class]:null;
					if (pierce) {
						if (attDefBonus) attDef = '(' + attDef + ')'
						attDef += ' - '+Math.round(pierce * 100) + '%';
						Ad *= (1-pierce);
					}
				}
			} else attAtt = attDef = 'n/a';
			var defTerrainValues = defender.terrain[defenderTerrain];
			var defenderBonus = 0;
			if (defTerrainValues) {
				var defAttBonus = defTerrainValues[1];
				var defDefBonus = defTerrainValues[2];
				if (attacker.maxRange < defender.minRange || attacker.minRange > defender.maxRange) {
					Da = 0;
					defAtt = 'out of range';
				} else
				if (defAtt) {
					Da += defAttBonus;
					if (defAttBonus > 0) defAtt = defAtt + "+" + defAttBonus;
					else if (defAttBonus < 0) defAtt = defAtt + "" + defAttBonus;
					var x = parseInt($$("defVeteran").getValue());
					if (x) defAtt = defAtt + "+" + x;
					Da += x;
					defenderBonus =+ x;
				}
				if (defDef) {
					Dd += defDefBonus;
					if (defDefBonus > 0) defDef = defDef + "+" + defDefBonus;
					else if (defDefBonus < 0) defDef = defDef + "" + defDefBonus;
					var pierce = attacker.armorPiercing ? attacker.armorPiercing[defender.class] : null;
					if (pierce) {
						if (defDefBonus) defDef = '(' + defDef + ')'
						defDef += ' - '+Math.round(pierce * 100) + '%';
						Dd *= (1-pierce);
					}
				}
			} else defAtt = defDef = 'n/a';
			
			var p1 = Aa ? 0.5 + 0.05 * (Aa-Dd) : 0;
			p1 = Math.min(Math.max(p1, 0), 1);
			var p2 = Da ? 0.5 + 0.05 * (Da-Ad) : 0;
			p2 = Math.min(Math.max(p2, 0), 1);
			

			damage_dataset = [];			
			if (defenderTerrain != '') {
				result1 = processAttack(attacker, attackerTerrain, Ah, attackerBonus, defender, defenderTerrain, Dh, 1);
			
				result2 = processAttack(defender, defenderTerrain, Dh, defenderBonus, attacker, attackerTerrain, Ah, 1);
			}
			var d1 = 0;
			var d2 = 0;
			var dmgLimit = Math.min(Ah, Dh);
			var coll1=0;
			var coll2=0;
			for (var i = 0; i<=dmgLimit; ++i) {
				var dmg1 = (chanceOfDamage(Ah, i, p1));
				if (i == Dh) dmg1 = 1-coll1;
				else if (i > Dh) dmg1 = 0;
				else coll1 += dmg1;
				d1 += (i * dmg1);
				
				var dmg2 = (chanceOfDamage(Dh, i, p2))*1;
				if (i == Ah) dmg2 = 1-coll2;
				else if (i > Ah) dmg2 = 0;
				else coll2 += dmg2;
				d2 += (i * dmg2);
				damage_dataset.push({
					att: Math.round(dmg1*1000)/10,
					def: Math.round(dmg2*1000)/10, 
					dmg: i })
			}

			d1 = Math.round(d1*10)/10;
			d2 = Math.round(d2*10)/10;*/
			if (!defenderTerrain) return;
			var Ah = parseInt($$('attHealth').getValue());
			var Dh = parseInt($$('defHealth').getValue());
			var attBonus = 0;
			var x = parseInt($$("attGangup").getValue());
			attBonus += x;
			var x = parseInt($$("attPopup").getValue())*4;
			attBonus += x;
			model = {
				units: [
					{ id: 1, rule: attacker, initialHealth: Ah, terrain: attackerTerrain, vet: parseInt($$("attVeteran").getValue())},
					{ id: 2, rule: defender, initialHealth: Dh, terrain: defenderTerrain, vet: parseInt($$("defVeteran").getValue())},
				],
				battles: [
					{ attId: 1, defId: 2, attTerrain: attackerTerrain, defTerrain: defenderTerrain, attBonus: attBonus, strikeBack: true }
				]
			};

			processData();
			
			var battle = model.battles[0];
			damage_dataset = [];			
			var dmgLimit = Math.min(Ah, Dh);
			for (var i = 0; i<=dmgLimit; ++i) {
				damage_dataset.push({
					att: Math.round(1000*battle.attackerDamage[i]) / 10,
					def: Math.round(1000*battle.defenderDamage[i]) / 10, 
					dmg: i })
			}
			
			var attTerrainValues = attacker.terrain[attackerTerrain];
			var defTerrainValues = defender.terrain[defenderTerrain];

            var obj = [
					{ prop: 'Unit', a: attacker.name, d: defender.name  },
					{ prop: 'Value', a: attacker.cost, d: defender.cost  },
					{ prop: 'Class', a: attacker.class, d: defender.class  },
					{ prop: 'p', a: Math.round(battle.p1*100)/100, d: Math.round(battle.p2*100)/100 },
					{ prop: 'Inflicted Damage', a: -battle.defLoss, d: -battle.attLoss },
					{ prop: 'Remaining Health', a: Math.round((Ah+battle.attLoss)*10)/10, d: Math.round((Dh+battle.defLoss)*10)/10 },
					{ prop: 'Credit loss', a: Math.round(-attacker.cost*battle.attLoss)/10, d: Math.round(-defender.cost*battle.defLoss)/10 },
					{ prop: 'Terrain effect', a: 
						'A: ' + (attTerrainValues[1] > 0 ? '+':'') +  attTerrainValues[1] +
						'  D: ' + (attTerrainValues[2] > 0 ? '+':'') +  attTerrainValues[2],
					 d: 
						'A: ' + (defTerrainValues[1] > 0 ? '+':'') +  defTerrainValues[1] +
						'  D: ' + (defTerrainValues[2] > 0 ? '+':'') +  defTerrainValues[2]},
					{ prop: 'Attack (w/o bonus)', a: attacker.attack[defender.class], d: defender.attack[attacker.class] },
					{ prop: 'Armor Piercing', a: attacker.armorPiercing[defender.class], d: defender.armorPiercing[attacker.class] },
					{ prop: 'Defense', a: attacker.defense, d: defender.defense  }
				];
            table.clearAll();
            table.parse(obj);  
			$$("chart").clearAll();
			$$("chart").parse(damage_dataset);
        }
        
    var selectAttacker = {view:"tree",
            select: 1,
			width: 300,
  			id: 'attacker',
			on: {
                onSelectChange:function (id) {
                attackerId = id;
                attacker = RuleSet.Unit[id];
				if (attacker.canPopup) $$("attPopup").enable();
				else {
					$$("attPopup").disable();
					$$("attPopup").setValue(0);
					}
				var t=$$("attackerTerrain");
				if (t) {
					var x = t.getSelectedId();
					t.clearAll();
					var d = terrainData.filter(function(value) {
						return attacker.terrain[value.id]
					});
					t.parse(d);
					if (! attacker.terrain[x] ) x = d[0].id;
					t.select(x);
					t.showItem(x);
				}
                //updateTable();
                }
            },
			data: {id:"root", value:"Races", open:true, data: unitData}
        };
    var selectAttackerTerrain = {view:"grouplist",
            select: 1,
  			id: 'attackerTerrain',
            on: {
                onSelectChange:function (id) {
                attackerTerrain = id[0];
                updateTable();
                }
            },
            data: {id:"root", value:"Terrain", open:true, data: terrainData}
        };
    var selectDefender = {view:"tree",
            select: 1,
			width: 300,
			id: 'defender',
           on: {
                onSelectChange:function (id) {
                defenderId = id;
                defender = RuleSet.Unit[id];;
				var t=$$("defenderTerrain");
				if (t) {
					var x = t.getSelectedId();
					t.clearAll();
					var d = terrainData.filter(function(value) {
						return defender.terrain[value.id]
					});
					t.parse(d);
					if (! defender.terrain[x] ) x = d[0].id;
					t.select(x);
					t.showItem(x);
				}
                //updateTable();
                }
            },
            data: {id:"root", value:"Races", open:true, data: JSON.parse(JSON.stringify(unitData))}
            };
    var selectDefenderTerrain = {view:"grouplist",
            select: 1,
   			id: 'defenderTerrain',
            on: {
                onSelectChange:function (id) {
                defenderTerrain = id[0];
                updateTable();
                }
            },
            data: {id:"root", value:"Terrain", open:true, data: JSON.parse(JSON.stringify(terrainData))}
            };
			
			
        
    webix.ui({
		padding: 10,
		margin: 10,
        cols: [
			{rows: [
				{ template:"Attacker", type:"header" },
				selectAttacker,
				{ view:"slider", id: 'attHealth', label:"Health", value:"10", min:1, max: 12, name:"s1", title:webix.template("#value#")},
				 {view:"radio", id: 'attVeteran', label: 'Veteran', value: '0', options:['0', "1", "2"]},
				 {view:"radio", id: 'attGangup', label: 'Gangup', value: '0', options:['0', "1", "2", '3']},
				 {view:"checkbox", id: 'attPopup', label: 'Unbury', value: 0},
				selectAttackerTerrain]},
            {
			rows: [
				{ template:"Defender", type:"header" },
				selectDefender,
				
				{view:"slider", id: 'defHealth', label:"Health", value:"10", min:1, max: 12, name:"s1", title:webix.template("#value#")},
				 {view:"radio", id: 'defVeteran', label: 'Veteran', value: '0', options:['0', "1", "2"]},
				 { view:"label", label: ""},
				 { view:"label", label: ""},
				selectDefenderTerrain]},
			{rows: [
				{ template:"Result", type:"header" },
				{view:"datatable", id: 'datatable', 
					columns:[
						{ id:"prop",	header:"", 		width:150},
						{ id:"a",	header:"Attacker",	width:150, editor: "text"},
						{ id:"d",	header:"Defender" , width:150, editor: "text"}
					],
					select:"row",
					autoheight:false,
					autowidth:true,
					editable:true,
					editaction: "custom",
					on:{
						onAfterSelect: function (data,prevent) {
							if (data.column == "prop" || this.getIndexById(data.row) < 8) return;
							this.editCell(data.row, data.column);
						},
						onAfterEditStop: function (state,editor,ignore) {
							if (state.old == state.value) return;
							var unit1;
							var unit2;
							if (editor.column == "a") { unit1 = attacker; unit2 = defender; }
							else { unit1=defender; unit2 = attacker; }
							switch (this.getIndexById(editor.row)) {
								case 8: // Attack
									unit1.attack[unit2.class] = parseInt(state.value);
									break;
								case 9: // Armor Piercing
									unit1.armorPiercing[unit2.class] = parseFloat(state.value);
									break;
								case 10: // Defense
									unit1.defense = parseInt(state.value);
									break;
							}
							updateTable();
						}
					}, 
					data: []},
				{view:"chart",
					type:"area",
					id: "chart",

					xAxis:{
						template:"#dmg#"
					},
					yAxis:{
						start:0,
						step:10
					},
					legend:{
						values:[{text:"Attacker",color:"#1293f8"},{text:"Defender",color:"#66cc00"}],
						align:"right",
						valign:"middle",
						layout:"y",
						width: 100,
						margin: 8
					},
					eventRadius: 5,
					series:[
						{
							value:"#att#",
							alpha: 0.5,
							color: "#1293f8",
							item:{
								borderColor: "#1293f8",
								color: "#ffffff"
							},
							line:{
								color:"#1293f8",
								width:3
							},
							tooltip:{
								template:"#att#%"
							}
						},
						{
							value:"#def#",
							alpha: 0.5,
							color: "#66cc00",
							item:{
								borderColor: "#66cc00",
								color: "#ffffff"
							},
							line:{
								color:"#66cc00",
								width:3
							},
							tooltip:{
								template:"#def#%"
							}
						}
					]/*,
					data:  multiple_dataset*/
				}					
			]}
		]
    });        
	$$('attacker').showItem('borfly');
	$$('attacker').select('borfly');
	$$('attackerTerrain').select('forest');
	$$('defender').showItem('eclipse');
	$$('defender').select('eclipse');
	$$('defenderTerrain').select('base');
	
	$$("attHealth").attachEvent("onSliderDrag", updateTable);
	$$("attVeteran").attachEvent("onChange", updateTable);
	$$("attGangup").attachEvent("onChange", updateTable);
	$$("attPopup").attachEvent("onChange", updateTable);
	$$("defHealth").attachEvent("onSliderDrag", updateTable);
	$$("defVeteran").attachEvent("onChange", updateTable);

        </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89381145-1', 'auto');
  ga('send', 'pageview');

</script>

    </body>
</html>